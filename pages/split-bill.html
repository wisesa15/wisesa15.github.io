---
layout: default
title: Bill Splitter
permalink: /split-bill/
---

<style>
    [data-theme="dark"] input {
    color: white;
    }
    [data-theme="dark"] .table {
    color: white;
    }
</style>

<div class="container my-5">
    <h2 class="text-center">Bill Splitter</h2>

    <div class="card p-3">
        <h3>People</h3>
        <button class="btn btn-primary my-2" onclick="addPerson()">Add Person</button>
        
        <div class="table-responsive">
            <table id="peopleTable" class="table table-sm">
                <thead class="thead">
                    <tr>
                        <th>Name</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="card p-3 mt-4">
        <h3>Enter Expenses</h3>
        <button class="btn btn-success my-2" onclick="addExpense()">Add Expense</button>
        
        <div class="table-responsive">
            <table id="expenseTable" class="table table-sm">
                <thead class="thead">
                    <tr>
                        <th>Payer</th>
                        <th>Amount</th>
                        <th>Discount</th>
                        <th>Description</th>
                        <th>Distribution</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <button class="btn btn-warning mt-3" onclick="calculateSplit()">Calculate</button>
    </div>

    <div class="result mt-4" id="output"></div>
</div>

<script>
    let people = [];
    let expenses = [];

    function getNextId() {
        return people.length > 0 ? Math.max(...people.map(p => p.id)) + 1 : 1;
    }

    function addPerson(person = {"id": getNextId(), "name": `Person ${getNextId()}`}) {
        people.push(person);

        // Add the new person to the distribution of all existing expenses
        expenses.forEach(expense => {
            expense.distribution.push({ personId: person.id, share: 1 });
        });

        updatePeopleTable();
        updateExpenseTable();

        setTimeout(() => {
            let lastRow = document.getElementById("peopleTable").rows[people.length];
            let inputField = lastRow.cells[0].querySelector("input");
            inputField.focus();
            inputField.select();
        }, 0);
    }

    function removePerson(index) {
        let removedPerson = people.splice(index, 1)[0];

        // Remove the person from the distribution of all existing expenses
        expenses.forEach(expense => {
            expense.distribution = expense.distribution.filter(dist => dist.personId !== removedPerson.id);
        });

        updatePeopleTable();
        updateExpenseTable();
    }

    function updatePeopleTable() {
        let table = document.querySelector("#peopleTable tbody");
        table.innerHTML = ``;

        people.forEach((person, index) => {
            let row = table.insertRow();
            row.insertCell(0).innerHTML = `<input type="text" value="${person.name}" onchange="updatePersonName(${index}, this.value)">`;
            row.insertCell(1).innerHTML = `<button onclick="removePerson(${index})">Remove</button>`;
        });
    }

    function updatePersonName(index, newName) {
        people[index].name = newName;
        updateExpenseTable();
    }

    function addExpense() {
        let expense = {
            id: expenses.length + 1,
            payer: people[0]?.id || null,
            amount: 0,
            discount: 0, // Default discount is 0
            description: "",
            distribution: people.map(p => ({ personId: p.id, share: 1 })) // Initialize distribution for all people
        };
        expenses.push(expense);
        updateExpenseTable();

        setTimeout(() => {
            let lastRow = document.querySelector("#expenseTable tbody").lastChild;
            let inputField = lastRow.cells[1].querySelector("input");
            inputField.focus();
            inputField.select();
        }, 0);
    }

    function updateExpenseTable() {
        let table = document.querySelector("#expenseTable tbody");
        table.innerHTML = ``;

        expenses.forEach((expense, index) => {
            let row = table.insertRow();
            
            let payerCell = row.insertCell(0);
            let amountCell = row.insertCell(1);
            let discountCell = row.insertCell(2);
            let descCell = row.insertCell(3);
            let distCell = row.insertCell(4);
            let actionCell = row.insertCell(5);
            
            payerCell.innerHTML = `<select onchange="updateExpensePayer(${index}, this.value)">${people.map(p => `<option value=${p.id} ${p.id === expense.payer ? 'selected' : ''}>${p.name}</option>`).join('')}</select>`;
            amountCell.innerHTML = `
                <div style="display: inline-flex; align-items: center; gap: 5px;">
                <button onclick="changeAmount(this, -1, ${index}, 'amount')">-</button>
                <input type="text" value="${expense.amount.toLocaleString()}" oninput="formatNumber(this)" onblur="ensureNumber(this); updateExpenseAmount(${index}, this.value)">
                <button onclick="changeAmount(this, 1, ${index}, 'amount')">+</button>
                </div>
            `;
            discountCell.innerHTML = `
                <div style="display: inline-flex; align-items: center; gap: 5px;">
                <button onclick="changeAmount(this, -1, ${index}, 'discount')">-</button>
                <input type="text" value="${expense.discount.toLocaleString()}" oninput="formatNumber(this)" onblur="ensureNumber(this); updateExpenseDiscount(${index}, this.value)">
                <button onclick="changeAmount(this, 1, ${index}, 'discount')">+</button>
                </div>
            `;
            descCell.innerHTML = `<input type="text" value="${expense.description}" onchange="updateExpenseDescription(${index}, this.value)">`;

            let distInputs = expense.distribution.map((dist, i) => `
                <div style="display: flex; align-items: center; justify-content: space-around; gap: 5px;">
                    <span style="flex-grow: 1; text-align: left;">${people.find(p => p.id === dist.personId).name}:</span>
                    <div style="display: inline-flex; align-items: center; gap: 5px;">
                        <button onclick="changeDistribution(this, -1, ${index}, ${i})">-</button>
                        <input type="text" value="${dist.share}" oninput="formatNumber(this)" onblur="ensureNumber(this); updateExpenseDistribution(${index}, ${i}, this.value)">
                        <button onclick="changeDistribution(this, 1, ${index}, ${i})">+</button>
                    </div>
                </div>`).join('<br>');
            distCell.innerHTML = distInputs;

            actionCell.innerHTML = `<button onclick="removeExpense(${index})">Remove</button>`;
        });
    }

    function removeExpense(index) {
        expenses.splice(index, 1);
        updateExpenseTable();
    }

    function updateExpensePayer(index, payerId) {
        expenses[index].payer = parseInt(payerId);
    }

    function updateExpenseAmount(index, amount) {
        expenses[index].amount = parseFloat(amount.replace(/,/g, "")) || 0;
    }

    function updateExpenseDiscount(index, discount) {
        expenses[index].discount = parseFloat(discount.replace(/,/g, "")) || 0;
    }

    function updateExpenseDescription(index, description) {
        expenses[index].description = description;
    }

    function updateExpenseDistribution(index, distIndex, share) {
        expenses[index].distribution[distIndex].share = parseFloat(share.replace(/,/g, "")) || 0;
    }

    function formatNumber(input) {
        let value = input.value.replace(/,/g, "").replace(/[^\d]/g, ""); 
        input.value = value ? Number(value).toLocaleString() : "0";
    }

    function ensureNumber(input) {
        if (input.value === "") input.value = "0";
    }

    function changeAmount(button, direction, index, type) {
        let input = button.parentNode.querySelector("input");
        let value = parseInt(input.value.replace(/,/g, ""), 10) || 0;
        let step = Math.pow(10, Math.floor(Math.log10(value || 1)));
        input.value = (value + step * direction).toLocaleString();

        if (type === 'amount') {
            updateExpenseAmount(index, input.value);
        } else if (type === 'discount') {
            updateExpenseDiscount(index, input.value);
        }
    }

    function changeDistribution(button, direction, expenseIndex, distIndex) {
        let input = button.parentNode.querySelector("input");
        let value = parseInt(input.value.replace(/,/g, ""), 10) || 0;
        let step = Math.pow(10, Math.floor(Math.log10(value || 1)));
        input.value = (value + step * direction).toLocaleString();
        updateExpenseDistribution(expenseIndex, distIndex, input.value);
    }

    function calculateSplit() {
        let balances = {};

        expenses.forEach(expense => {
            let payer = expense.payer;
            let amount = expense.amount;
            let discount = expense.discount;
            let distribution = expense.distribution;

            // Apply discount to the total amount of this expense
            let totalAfterDiscount = amount - discount;

            if (!balances[payer]) balances[payer] = 0;
            balances[payer] += totalAfterDiscount; // Payer pays the discounted amount

            // Calculate the total shares for distribution
            let totalShares = distribution.reduce((sum, dist) => sum + dist.share, 0);

            // Distribute the remaining amount (after discount) based on shares
            distribution.forEach(dist => {
                let personId = dist.personId;
                let share = (dist.share / totalShares) * totalAfterDiscount;

                if (!balances[personId]) balances[personId] = 0;
                balances[personId] -= share; // Each person owes their share
            });
        });

        let creditors = [], debtors = [];
        for (let personId in balances) {
            let balance = balances[personId];
            if (balance > 0) creditors.push([personId, balance]);
            else if (balance < 0) debtors.push([personId, -balance]);
        }
        
        let results = [];
        while (creditors.length > 0 && debtors.length > 0) {
            let [cId, cAmount] = creditors.pop();
            let cName = people.find(p => p.id === parseInt(cId)).name;
            let [dId, dAmount] = debtors.pop();
            let dName = people.find(p => p.id === parseInt(dId)).name;
            let payAmount = Math.min(cAmount, dAmount);

            results.push(`${dName} pays ${cName} Rp ${payAmount.toLocaleString()}`);
            
            if (cAmount > dAmount) creditors.push([cId, cAmount - dAmount]);
            else if (dAmount > cAmount) debtors.push([dId, dAmount - cAmount]);
        }

        document.getElementById("output").innerHTML = `<h3>Transactions:</h3><ul>` + 
            results.map(r => `<li>${r}</li>`).join("") + `</ul>`;
    }
</script>
