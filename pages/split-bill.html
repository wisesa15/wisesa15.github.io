---
layout: default
title: Bill Splitter
permalink: /split-bill/
---

<style>
    [data-theme="dark"] input {
    color: white;
    }
    [data-theme="dark"] .table {
    color: white;
    }
</style>

<div class="container my-5">
    <!-- Chat Toggle Button -->
    <div class="text-center mb-4">
        <button id="chatToggle" class="btn btn-info" onclick="toggleChat()">Activate Chat</button>
        <button id="resetButton" class="btn btn-danger" onclick="resetChat()">Reset</button>
    </div>

    <!-- Chat Interface -->
    <div id="chatContainer" class="card p-3 mb-4" style="display: none;">
        <h3>Chat with Bill Splitter</h3>
        <div id="chatBox" style="height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
            <div id="chatMessages"></div>
        </div>
        <div class="input-group">
            <input type="text" id="chatInput" class="form-control" placeholder="Tell me about your bill..." onkeypress="handleChatInput(event)" disabled>
            <button id="sendButton" class="btn btn-primary" onclick="sendChatMessage()" disabled>Send</button>
        </div>
    </div>

    <h2 class="text-center">Bill Splitter</h2>

    <!-- People Section -->
    <div class="card p-3">
        <h3>People</h3>
        <button class="btn btn-primary my-2" onclick="addPerson()">Add Person</button>
        
        <div class="table-responsive">
            <table id="peopleTable" class="table table-sm">
                <thead class="thead">
                    <tr>
                        <th>Name</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Expenses Section -->
    <div class="card p-3 mt-4">
        <h3>Enter Expenses</h3>
        <button class="btn btn-success my-2" onclick="addExpense()">Add Expense</button>
        
        <div class="table-responsive">
            <table id="expenseTable" class="table table-sm">
                <thead class="thead">
                    <tr>
                        <th>Payer</th>
                        <th>Amount</th>
                        <th>Discount</th>
                        <th>Description</th>
                        <th>Distribution</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <button class="btn btn-warning mt-3" onclick="calculateSplit()">Calculate</button>
    </div>

    <!-- Results Section -->
    <div class="result mt-4" id="output"></div>
</div>

<script>
    let people = [];
    let expenses = [];
    let chatActive = false;

    // Chat Toggle Function
    function toggleChat() {
        const chatContainer = document.getElementById("chatContainer");
        const chatToggle = document.getElementById("chatToggle");
        const chatInput = document.getElementById("chatInput");
        const sendButton = document.getElementById("sendButton");

        chatActive = !chatActive;

        if (chatActive) {
            chatContainer.style.display = "block";
            chatToggle.textContent = "Deactivate Chat";
            chatInput.disabled = false;
            sendButton.disabled = false;
        } else {
            chatContainer.style.display = "none";
            chatToggle.textContent = "Activate Chat";
            chatInput.disabled = true;
            sendButton.disabled = true;
        }
    }

    // Reset Function
    function resetChat() {
        // Clear chat messages
        document.getElementById("chatMessages").innerHTML = "";

        // Clear people and expenses
        people = [];
        expenses = [];

        // Update UI
        updatePeopleTable();
        updateExpenseTable();

        // Reset output
        document.getElementById("output").innerHTML = "";

        // Deactivate chat
        chatActive = false;
        document.getElementById("chatContainer").style.display = "none";
        document.getElementById("chatToggle").textContent = "Activate Chat";
        document.getElementById("chatInput").disabled = true;
        document.getElementById("sendButton").disabled = true;
    }

    // Chat Interface Functions
    function addChatMessage(message, isUser = true) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = isUser ? "text-end" : "text-start";
        messageDiv.innerHTML = `<div class="alert ${isUser ? 'alert-primary' : 'alert-secondary'}" role="alert">${message}</div>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to bottom
    }

    async function sendChatMessage() {
        const chatInput = document.getElementById("chatInput");
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;

        addChatMessage(userMessage, true); // Add user message to chat
        chatInput.value = ""; // Clear input

        // Simulate LLM API call
        const llmResponse = await callLLMAPI(userMessage);

        addChatMessage(llmResponse, false); // Add LLM response to chat

        // Parse LLM response and update application state
        parseLLMResponse(llmResponse);

        // Disable chat input and send button after processing
        chatInput.disabled = true;
        document.getElementById("sendButton").disabled = true;
    }

    function handleChatInput(event) {
        if (event.key === "Enter") {
            sendChatMessage();
        }
    }

    // Simulated LLM API Call
    async function callLLMAPI(userMessage) {
        // Replace this with an actual API call to your LLM
        // For now, we simulate a JSON response
        return new Promise((resolve) => {
            setTimeout(() => {
                const response = JSON.stringify({
                    "people": ["Priyo", "Rakha", "Nopa", "Lukas"],
                    "expenses": [
                        {
                            "payer": "Lukas",
                            "amount": 70000,
                            "description": "Billiard",
                            "distribution": {
                                "Priyo": 1,
                                "Rakha": 1,
                                "Nopa": 1,
                                "Lukas": 1
                            }
                        },
                        {
                            "payer": "Lukas",
                            "amount": 84000,
                            "description": "Food",
                            "distribution": {
                                "Rakha": 1,
                                "Lukas": 1
                            }
                        },
                        {
                            "payer": "Rakha",
                            "amount": 68000,
                            "discount": 5000,
                            "description": "Coffee",
                            "distribution": {
                                "Priyo": 20000,
                                "Lukas": 24000,
                                "Rakha": 24000
                            }
                        }
                    ]
                });
                resolve(response);
            }, 1000); // Simulate API delay
        });
    }

    // Parse LLM Response and Update Application State
    function parseLLMResponse(response) {
        // Clear existing data
        people = [];
        expenses = [];

        // Parse the JSON response
        const data = JSON.parse(response);

        // Convert people array into objects with IDs
        data.people.forEach((name, index) => {
            people.push({ id: index + 1, name });
        });

        // Convert expenses array into the required format
        data.expenses.forEach((expense, index) => {
            const payer = people.find(p => p.name === expense.payer);
            if (payer) {
                const distribution = Object.entries(expense.distribution).map(([name, share]) => {
                    const person = people.find(p => p.name === name);
                    return { personId: person.id, share };
                });

                const newExpense = {
                    id: expenses.length + 1,
                    payer: payer.id,
                    amount: expense.amount,
                    discount: expense.discount || 0,
                    description: expense.description,
                    distribution
                };
                expenses.push(newExpense);
            }
        });

        // Update UI
        updatePeopleTable();
        updateExpenseTable();
    }

    // Existing Functions (unchanged)
    function getNextId() {
        return people.length > 0 ? Math.max(...people.map(p => p.id)) + 1 : 1;
    }

    function addPerson(person = {"id": getNextId(), "name": `Person ${getNextId()}`}) {
        people.push(person);
        updatePeopleTable();
        updateExpenseTable();
    }

    function removePerson(index) {
        people.splice(index, 1);
        updatePeopleTable();
        updateExpenseTable();
    }

    function updatePeopleTable() {
        let table = document.querySelector("#peopleTable tbody");
        table.innerHTML = ``;

        people.forEach((person, index) => {
            let row = table.insertRow();
            row.insertCell(0).innerHTML = `<input type="text" value="${person.name}" onchange="updatePersonName(${index}, this.value)">`;
            row.insertCell(1).innerHTML = `<button onclick="removePerson(${index})">Remove</button>`;
        });
    }

    function updatePersonName(index, newName) {
        people[index].name = newName;
        updateExpenseTable();
    }

    function addExpense() {
        let expense = {
            id: expenses.length + 1,
            payer: people[0]?.id || null,
            amount: 0,
            discount: 0,
            description: "",
            distribution: people.map(p => ({ personId: p.id, share: 1 }))
        };
        expenses.push(expense);
        updateExpenseTable();
    }

    function updateExpenseTable() {
        let table = document.querySelector("#expenseTable tbody");
        table.innerHTML = ``;

        expenses.forEach((expense, index) => {
            let row = table.insertRow();
            
            let payerCell = row.insertCell(0);
            let amountCell = row.insertCell(1);
            let discountCell = row.insertCell(2);
            let descCell = row.insertCell(3);
            let distCell = row.insertCell(4);
            let actionCell = row.insertCell(5);
            
            payerCell.innerHTML = `<select onchange="updateExpensePayer(${index}, this.value)">${people.map(p => `<option value=${p.id} ${p.id === expense.payer ? 'selected' : ''}>${p.name}</option>`).join('')}</select>`;
            amountCell.innerHTML = `
                <div style="display: inline-flex; align-items: center; gap: 5px;">
                <button onclick="changeAmount(this, -1, ${index}, 'amount')">-</button>
                <input type="text" value="${expense.amount.toLocaleString()}" oninput="formatNumber(this)" onblur="ensureNumber(this); updateExpenseAmount(${index}, this.value)">
                <button onclick="changeAmount(this, 1, ${index}, 'amount')">+</button>
                </div>
            `;
            discountCell.innerHTML = `
                <div style="display: inline-flex; align-items: center; gap: 5px;">
                <button onclick="changeAmount(this, -1, ${index}, 'discount')">-</button>
                <input type="text" value="${expense.discount.toLocaleString()}" oninput="formatNumber(this)" onblur="ensureNumber(this); updateExpenseDiscount(${index}, this.value)">
                <button onclick="changeAmount(this, 1, ${index}, 'discount')">+</button>
                </div>
            `;
            descCell.innerHTML = `<input type="text" value="${expense.description}" onchange="updateExpenseDescription(${index}, this.value)">`;

            let distInputs = expense.distribution.map((dist, i) => `
                <div style="display: flex; align-items: center; justify-content: space-around; gap: 5px;">
                    <span style="flex-grow: 1; text-align: left;">${people.find(p => p.id === dist.personId).name}:</span>
                    <div style="display: inline-flex; align-items: center; gap: 5px;">
                        <button onclick="changeDistribution(this, -1, ${index}, ${i})">-</button>
                        <input type="text" value="${dist.share}" oninput="formatNumber(this)" onblur="ensureNumber(this); updateExpenseDistribution(${index}, ${i}, this.value)">
                        <button onclick="changeDistribution(this, 1, ${index}, ${i})">+</button>
                    </div>
                </div>`).join('<br>');
            distCell.innerHTML = distInputs;

            actionCell.innerHTML = `<button onclick="removeExpense(${index})">Remove</button>`;
        });
    }

    function removeExpense(index) {
        expenses.splice(index, 1);
        updateExpenseTable();
    }

    function updateExpensePayer(index, payerId) {
        expenses[index].payer = parseInt(payerId);
    }

    function updateExpenseAmount(index, amount) {
        expenses[index].amount = parseFloat(amount.replace(/,/g, "")) || 0;
    }

    function updateExpenseDiscount(index, discount) {
        expenses[index].discount = parseFloat(discount.replace(/,/g, "")) || 0;
    }

    function updateExpenseDescription(index, description) {
        expenses[index].description = description;
    }

    function updateExpenseDistribution(index, distIndex, share) {
        expenses[index].distribution[distIndex].share = parseFloat(share.replace(/,/g, "")) || 0;
    }

    function formatNumber(input) {
        let value = input.value.replace(/,/g, "").replace(/[^\d]/g, ""); 
        input.value = value ? Number(value).toLocaleString() : "0";
    }

    function ensureNumber(input) {
        if (input.value === "") input.value = "0";
    }

    function changeAmount(button, direction, index, type) {
        let input = button.parentNode.querySelector("input");
        let value = parseInt(input.value.replace(/,/g, ""), 10) || 0;
        let step = Math.pow(10, Math.floor(Math.log10(value || 1)));
        input.value = (value + step * direction).toLocaleString();

        if (type === 'amount') {
            updateExpenseAmount(index, input.value);
        } else if (type === 'discount') {
            updateExpenseDiscount(index, input.value);
        }
    }

    function changeDistribution(button, direction, expenseIndex, distIndex) {
        let input = button.parentNode.querySelector("input");
        let value = parseInt(input.value.replace(/,/g, ""), 10) || 0;
        let step = Math.pow(10, Math.floor(Math.log10(value || 1)));
        input.value = (value + step * direction).toLocaleString();
        updateExpenseDistribution(expenseIndex, distIndex, input.value);
    }

    function calculateSplit() {
        let balances = {};

        expenses.forEach(expense => {
            let payer = expense.payer;
            let amount = expense.amount;
            let discount = expense.discount;
            let distribution = expense.distribution;

            let totalAfterDiscount = amount - discount;

            if (!balances[payer]) balances[payer] = 0;
            balances[payer] += totalAfterDiscount;

            let totalShares = distribution.reduce((sum, dist) => sum + dist.share, 0);

            distribution.forEach(dist => {
                let personId = dist.personId;
                let share = (dist.share / totalShares) * totalAfterDiscount;

                if (!balances[personId]) balances[personId] = 0;
                balances[personId] -= share;
            });
        });

        let creditors = [], debtors = [];
        for (let personId in balances) {
            let balance = balances[personId];
            if (balance > 0) creditors.push([personId, balance]);
            else if (balance < 0) debtors.push([personId, -balance]);
        }
        
        let results = [];
        while (creditors.length > 0 && debtors.length > 0) {
            let [cId, cAmount] = creditors.pop();
            let cName = people.find(p => p.id === parseInt(cId)).name;
            let [dId, dAmount] = debtors.pop();
            let dName = people.find(p => p.id === parseInt(dId)).name;
            let payAmount = Math.min(cAmount, dAmount);

            results.push(`${dName} pays ${cName} Rp ${payAmount.toLocaleString()}`);
            
            if (cAmount > dAmount) creditors.push([cId, cAmount - dAmount]);
            else if (dAmount > cAmount) debtors.push([dId, dAmount - cAmount]);
        }

        document.getElementById("output").innerHTML = `<h3>Transactions:</h3><ul>` + 
            results.map(r => `<li>${r}</li>`).join("") + `</ul>`;
    }
</script>